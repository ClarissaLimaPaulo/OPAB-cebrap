<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análises - OPAB-CEBRAP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-dark: #1a1d35;
            --secondary-dark: #252946;
            --accent-green: #99c466;
            --accent-light: #8ab35b;
            --text-light: #e8eaf6;
            --text-muted: #9fa8c7;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            line-height: 1.6;
        }
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(26, 29, 53, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            color: var(--text-light);
        }
        .logo span { color: var(--accent-green); }
        .nav-links {
            display: flex;
            gap: 2.5rem;
            list-style: none;
        }
        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .nav-links a:hover { color: var(--accent-green); }
        .analysis-container {
            padding: 8rem 5% 4rem;
            max-width: 1800px;
            margin: 0 auto;
        }
        .page-header {
            text-align: center;
            margin-bottom: 4rem;
        }
        .page-title {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 1rem;
            letter-spacing: -2px;
        }
        .page-title span { color: var(--accent-green); }
        .page-description {
            color: var(--text-muted);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto 2rem;
            line-height: 1.8;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 4rem;
        }
        .stat-card {
            background: rgba(37, 41, 70, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-green);
        }
        .stat-icon {
            font-size: 3rem;
            color: var(--accent-green);
            margin-bottom: 1rem;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-green);
            display: block;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: var(--text-muted);
            font-size: 1rem;
        }
        .section-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 3rem 0 2rem;
        }
        .section-title span { color: var(--accent-green); }
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        .chart-card {
            background: rgba(37, 41, 70, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2.5rem;
        }
        .chart-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .chart-note {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 1rem;
            text-align: center;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(37, 41, 70, 0.95);
            padding: 2rem 3rem;
            border-radius: 15px;
            text-align: center;
            z-index: 2000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-table {
            background: rgba(37, 41, 70, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2.5rem;
            overflow-x: auto;
            margin-bottom: 3rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: rgba(153, 196, 102, 0.2);
            color: var(--text-light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--accent-green);
        }
        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
        }
        tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }
        @media (max-width: 768px) {
            .analysis-container {
                padding: 6rem 1rem 2rem;
            }
            .page-title {
                font-size: 2.5rem;
            }
            .charts-row {
                grid-template-columns: 1fr;
            }
            .nav-links { display: none; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>Carregando dados...</div>
    </div>

    <nav>
        <a href="index.html" class="logo">OPAB<span>-CEBRAP</span></a>
        <ul class="nav-links">
            <li><a href="index.html">Início</a></li>
            <li><a href="map.html">Mapa</a></li>
            <li><a href="timeline.html">Linha do Tempo</a></li>
            <li><a href="analysis.html">Análises</a></li>
        </ul>
    </nav>

    <div class="analysis-container">
        <div class="page-header">
            <h1 class="page-title">Análises <span>Detalhadas</span></h1>
            <p class="page-description">
                Análise aprofundada dos padrões de violência política no Brasil (2003-2023)
            </p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
                <span class="stat-value" id="totalCases">0</span>
                <span class="stat-label">Total de Casos</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-skull-crossbones"></i></div>
                <span class="stat-value" id="totalAssassinations">0</span>
                <span class="stat-label">Assassinatos</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-heartbeat"></i></div>
                <span class="stat-value" id="totalAttempts">0</span>
                <span class="stat-label">Tentativas</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-shield-alt"></i></div>
                <span class="stat-value" id="totalThreats">0</span>
                <span class="stat-label">Ameaças</span>
            </div>
        </div>

        <h2 class="section-title">Distribuição <span>Geográfica</span></h2>
        <div class="charts-row">
            <div class="chart-card">
                <h3 class="chart-card-title">Top 10 Estados</h3>
                <canvas id="stateChart"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-card-title">Top 10 Cidades</h3>
                <canvas id="cityChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">Perfil das <span>Vítimas</span></h2>
        <div class="charts-row">
            <div class="chart-card">
                <h3 class="chart-card-title">Tipo de Vítima (Macro)</h3>
                <canvas id="victimMacroChart"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-card-title">Tipo de Vítima (Micro)</h3>
                <canvas id="victimMicroChart"></canvas>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-card">
                <h3 class="chart-card-title">Distribuição por Gênero</h3>
                <canvas id="genderChart"></canvas>
                <p class="chart-note">* Gênero predito utilizando Machine Learning</p>
            </div>
            <div class="chart-card">
                <h3 class="chart-card-title">Tipo de Ação</h3>
                <canvas id="actionTypeChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">Métodos e <span>Instrumentos</span></h2>
        <div class="charts-row">
            <div class="chart-card">
                <h3 class="chart-card-title">Principais Instrumentos Utilizados</h3>
                <canvas id="weaponChart"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-card-title">Evolução dos Instrumentos ao Longo do Tempo</h3>
                <canvas id="weaponTimelineChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">Análise <span>Temporal</span></h2>
        <div class="charts-row" style="grid-template-columns: 1fr;">
            <div class="chart-card">
                <h3 class="chart-card-title">Distribuição por Mês do Ano</h3>
                <canvas id="monthChart"></canvas>
            </div>
        </div>

        <h2 class="section-title">Tabela <span>Resumida</span></h2>
        <div class="data-table">
            <h3 style="margin-bottom: 1.5rem;">Casos por Estado</h3>
            <table id="stateTable">
                <thead>
                    <tr>
                        <th>Estado</th>
                        <th>Total</th>
                        <th>Assassinatos</th>
                        <th>Tentativas</th>
                        <th>Ameaças</th>
                        <th>% do Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};

        async function loadData() {
            try {
                const csvUrl = 'https://raw.githubusercontent.com/clarissalimapaulo/OPAB-cebrap/main/data/BAP%20-%20BAP.csv';
                
                Papa.parse(csvUrl, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allData = results.data;
                        initializeCharts();
                        updateStatistics();
                        updateAllCharts();
                        updateStateTable();
                        document.getElementById('loading').style.display = 'none';
                    },
                    error: function(error) {
                        console.error('Error loading CSV:', error);
                        document.getElementById('loading').innerHTML = '<div style="color: #99c466;">Erro ao carregar dados.</div>';
                    }
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateStatistics() {
            const total = allData.length;
            const assassinations = allData.filter(r => r['Tipo_ação_vítima']?.toLowerCase() === 'assassinato').length;
            const attempts = allData.filter(r => r['Tipo_ação_vítima']?.toLowerCase() === 'tentativa').length;
            const threats = allData.filter(r => r['Tipo_ação_vítima']?.toLowerCase() === 'ameaça').length;

            document.getElementById('totalCases').textContent = total;
            document.getElementById('totalAssassinations').textContent = assassinations;
            document.getElementById('totalAttempts').textContent = attempts;
            document.getElementById('totalThreats').textContent = threats;
        }

        function initializeCharts() {
            const barOptions = {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(37, 41, 70, 0.95)',
                        titleColor: '#e8eaf6',
                        bodyColor: '#e8eaf6',
                        borderColor: '#99c466',
                        borderWidth: 1,
                        padding: 12
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#9fa8c7' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9fa8c7' }
                    }
                }
            };

            const pieOptions = {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#e8eaf6',
                            padding: 15,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(37, 41, 70, 0.95)',
                        titleColor: '#e8eaf6',
                        bodyColor: '#e8eaf6',
                        borderColor: '#99c466',
                        borderWidth: 1,
                        padding: 12
                    }
                }
            };

            charts.state = new Chart(document.getElementById('stateChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: barOptions
            });

            charts.city = new Chart(document.getElementById('cityChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: barOptions
            });

            charts.victimMacro = new Chart(document.getElementById('victimMacroChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: pieOptions
            });

            charts.victimMicro = new Chart(document.getElementById('victimMicroChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { ...barOptions, indexAxis: 'y' }
            });

            charts.gender = new Chart(document.getElementById('genderChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: pieOptions
            });

            charts.actionType = new Chart(document.getElementById('actionTypeChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: pieOptions
            });

            charts.weapon = new Chart(document.getElementById('weaponChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { ...barOptions, indexAxis: 'y' }
            });

            charts.weaponTimeline = new Chart(document.getElementById('weaponTimelineChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...barOptions,
                    aspectRatio: 2,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e8eaf6',
                                padding: 10,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });

            charts.month = new Chart(document.getElementById('monthChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { ...barOptions, aspectRatio: 3 }
            });
        }

        function updateAllCharts() {
            updateStateChart();
            updateCityChart();
            updateVictimMacroChart();
            updateVictimMicroChart();
            updateGenderChart();
            updateActionTypeChart();
            updateWeaponChart();
            updateWeaponTimelineChart();
            updateMonthChart();
        }

        function countByField(field) {
            const counts = {};
            allData.forEach(row => {
                const value = row[field] || 'Não especificado';
                counts[value] = (counts[value] || 0) + 1;
            });
            return counts;
        }

        function updateStateChart() {
            const counts = countByField('UF');
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            charts.state.data.labels = sorted.map(([state]) => state);
            charts.state.data.datasets = [{
                data: sorted.map(([, count]) => count),
                backgroundColor: '#99c466',
                borderWidth: 0
            }];
            charts.state.update();
        }

        function updateCityChart() {
            const counts = countByField('Cidade');
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            charts.city.data.labels = sorted.map(([city]) => city);
            charts.city.data.datasets = [{
                data: sorted.map(([, count]) => count),
                backgroundColor: '#99c466',
                borderWidth: 0
            }];
            charts.city.update();
        }

        function updateVictimMacroChart() {
            const counts = countByField('Vítima_Tipo_Macro-Grupo');
            
            charts.victimMacro.data.labels = Object.keys(counts);
            charts.victimMacro.data.datasets = [{
                data: Object.values(counts),
                backgroundColor: ['#99c466', '#8ab35b', '#b3d98f', '#cce6b3', '#dcedc8'],
                borderWidth: 0
            }];
            charts.victimMacro.update();
        }

        function updateVictimMicroChart() {
            const counts = countByField('Vítima_Tipo_Grupo');
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            charts.victimMicro.data.labels = sorted.map(([type]) => type);
            charts.victimMicro.data.datasets = [{
                data: sorted.map(([, count]) => count),
                backgroundColor: '#99c466',
                borderWidth: 0
            }];
            charts.victimMicro.update();
        }

        function updateGenderChart() {
            const counts = countByField('Gênero_predito');
            
            charts.gender.data.labels = Object.keys(counts);
            charts.gender.data.datasets = [{
                data: Object.values(counts),
                backgroundColor: ['#99c466', '#8ab35b', '#b3d98f'],
                borderWidth: 0
            }];
            charts.gender.update();
        }

        function updateActionTypeChart() {
            const counts = countByField('Tipo_ação_vítima');
            
            charts.actionType.data.labels = Object.keys(counts);
            charts.actionType.data.datasets = [{
                data: Object.values(counts),
                backgroundColor: ['#99c466', '#8ab35b', '#b3d98f'],
                borderWidth: 0
            }];
            charts.actionType.update();
        }

        function updateWeaponChart() {
            const counts = countByField('Instrumento_1');
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 8);
            
            charts.weapon.data.labels = sorted.map(([weapon]) => weapon);
            charts.weapon.data.datasets = [{
                data: sorted.map(([, count]) => count),
                backgroundColor: '#99c466',
                borderWidth: 0
            }];
            charts.weapon.update();
        }

        function updateWeaponTimelineChart() {
            const weaponsByYear = {};
            const topWeapons = Object.entries(countByField('Instrumento_1'))
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([weapon]) => weapon);

            allData.forEach(row => {
                const year = row.Ano;
                const weapon = row.Instrumento_1 || 'Não especificado';
                
                if (!topWeapons.includes(weapon)) return;
                
                if (!weaponsByYear[year]) weaponsByYear[year] = {};
                weaponsByYear[year][weapon] = (weaponsByYear[year][weapon] || 0) + 1;
            });

            const years = Object.keys(weaponsByYear).sort();
            const colors = ['#99c466', '#8ab35b', '#b3d98f', '#cce6b3', '#dcedc8'];

            charts.weaponTimeline.data.labels = years;
            charts.weaponTimeline.data.datasets = topWeapons.map((weapon, idx) => ({
                label: weapon,
                data: years.map(year => weaponsByYear[year][weapon] || 0),
                borderColor: colors[idx],
                backgroundColor: colors[idx] + '40',
                borderWidth: 2,
                fill: false,
                tension: 0.3
            }));
            charts.weaponTimeline.update();
        }

        function updateMonthChart() {
            const monthCounts = {};
            const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            allData.forEach(row => {
                const month = parseInt(row['Mês']);
                if (month >= 1 && month <= 12) {
                    monthCounts[month] = (monthCounts[month] || 0) + 1;
                }
            });

            const data = [];
            for (let i = 1; i <= 12; i++) {
                data.push(monthCounts[i] || 0);
            }

            charts.month.data.labels = monthNames;
            charts.month.data.datasets = [{
                data: data,
                backgroundColor: '#99c466',
                borderWidth: 0
            }];
            charts.month.update();
        }

        function updateStateTable() {
            const stateData = {};
            
            allData.forEach(row => {
                const state = row.UF || 'Desconhecido';
                const type = row['Tipo_ação_vítima']?.toLowerCase();
                
                if (!stateData[state]) {
                    stateData[state] = {
                        total: 0,
                        assassinato: 0,
                        tentativa: 0,
                        ameaça: 0
                    };
                }
                
                stateData[state].total++;
                if (type === 'assassinato') stateData[state].assassinato++;
                else if (type === 'tentativa') stateData[state].tentativa++;
                else if (type === 'ameaça') stateData[state].ameaça++;
            });

            const sorted = Object.entries(stateData).sort((a, b) => b[1].total - a[1].total);
            const tbody = document.querySelector('#stateTable tbody');
            const total = allData.length;

            tbody.innerHTML = '';
            sorted.forEach(([state, data]) => {
                const percentage = ((data.total / total) * 100).toFixed(1);
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${state}</strong></td>
                        <td>${data.total}</td>
                        <td>${data.assassinato}</td>
                        <td>${data.tentativa}</td>
                        <td>${data.ameaça}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
        }

        loadData();
    </script>
</body>
</html>

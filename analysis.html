<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OPAB-CEBRAP — Análises</title>
  <style>
    body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#070708,#0e0e10);color:#eaeaea}
    header{padding:12px 18px;background:rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:space-between}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:18px}
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <a style="color:#ddd;text-decoration:none" href="index.html">← Voltar</a>
      <h1>Análises — OPAB-CEBRAP</h1>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <h3>Distribuição por gênero</h3>
      <canvas id="genderChart"></canvas>
    </div>
    <div class="card">
      <h3>Distribuição por região</h3>
      <canvas id="regionChart"></canvas>
    </div>
    <div class="card">
      <h3>Tipo de ação (amostra)</h3>
      <canvas id="actionChart"></canvas>
    </div>
    <div class="card">
      <h3>Resumo</h3>
      <div id="summary" style="color:#cfcfcf"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    function topNCounts(arr, n=8){
      const counts = {};
      arr.forEach(x=>{ if(!x) return; counts[x] = (counts[x]||0)+1 });
      const items = Object.keys(counts).map(k=>({k,v:counts[k]})).sort((a,b)=>b.v-a.v);
      return items.slice(0,n);
    }

    Papa.parse('data/BAP - BAP.csv',{download:true,header:true,skipEmptyLines:true,complete(res){
      const rows = res.data;
      const genders = rows.map(r=> (r['Gênero_predito']||r['Genero_predito']||r['Gênero']||r['Gênero_predito']||r['Genero']||'Desconhecido').trim() );
      const regions = rows.map(r=> (r['Região']||r['Regiao']||r['Região '||'Regiao']||r['Região']||'Desconhecida').trim() );
      const actions = rows.map(r=> (r['Tipo_ação_vítima']||r['Tipo_acao_vitima']||r['Tipo_ação']||r['Tipo_ação_vítima']||'Desconhecida').trim());

      // Gender chart
      const gTop = topNCounts(genders,6);
      const gLabels = gTop.map(x=>x.k);
      const gValues = gTop.map(x=>x.v);
      new Chart(document.getElementById('genderChart').getContext('2d'),{type:'pie',data:{labels:gLabels,datasets:[{data:gValues}]},options:{plugins:{legend:{position:'right'}}}});

      // Region chart
      const rTop = topNCounts(regions,6);
      new Chart(document.getElementById('regionChart').getContext('2d'),{type:'bar',data:{labels:rTop.map(x=>x.k),datasets:[{label:'Casos',data:rTop.map(x=>x.v)}]},options:{plugins:{legend:{display:false}}}});

      // Action chart
      const aTop = topNCounts(actions,6);
      new Chart(document.getElementById('actionChart').getContext('2d'),{type:'bar',data:{labels:aTop.map(x=>x.k),datasets:[{label:'Casos',data:aTop.map(x=>x.v)}]},options:{plugins:{legend:{display:false}}}});

      // summary
      const total = rows.length;
      const male = genders.filter(x=>/homem|masculino/i.test(x)).length;
      const female = genders.filter(x=>/mulher|feminino/i.test(x)).length;
      document.getElementById('summary').innerHTML = `<p>Total registros: <b>${total}</b></p><p>Homens aproxim.: <b>${male}</b> — Mulheres aproxim.: <b>${female}</b></p>`;
    },error(err){ console.error(err); alert('Erro ao carregar CSV: '+err.message) }});
  </script>
</body>
</html>
